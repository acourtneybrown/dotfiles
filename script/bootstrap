#!/usr/bin/env bash

set -e
cd "$(dirname "${0}")/.."

# shellcheck disable=SC1091
. script/functions

# Install oh-my-zsh
if [ ! -d ~/.oh-my-zsh ]; then
  if command -v curl >/dev/null; then
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh) --unattended"
  elif command -v wget >/dev/null; then
    sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -) --unattended"
  else
    abort "Either curl or wget must be installed"
  fi
fi

install_homebrew
ensure_brewfile_installed

# Install all dotfiles into the home directory
ensure_command "yq"

function ensure_profile_includes() {
  local profile
  local include

  profile=${1}
  include=${2}

  present=$(yq e "[\"${include}\"] - .profiles.\"${profile}\".include | length == 0" config.yaml)
  if [[ ${present} == "false" ]]; then
    yq eval ".profiles.\"${profile}\".\"include\" += [\"${include}\"]" -i config.yaml
  fi
}

# create a new profile (if necessary) and include default
PROFILE=$(hostname)
ensure_profile_includes "${PROFILE}" default
is_mac && ensure_profile_includes "${PROFILE}" mac && ensure_brewfile_installed Brewfile.mac
is_linux && ensure_profile_includes "${PROFILE}" linux && ensure_brewfile_installed Brewfile.linux

for extra in "${@}"; do
  ensure_profile_includes "${PROFILE}" "${extra}"
done

dotdrop install --force --profile="${PROFILE}" --cfg config.yaml

extract_gpg_key acourtneybrown@gmail.com

for extra in "${@}"; do
  if [ -f "./script/bootstrap-${extra}" ]; then
    "./script/bootstrap-${extra}"
  fi
done

enable_pyenv
enable_goenv
pyenv global "$(ensure_pyenv_version 3.11)"
goenv global "$(ensure_goenv_version 1.19)"
