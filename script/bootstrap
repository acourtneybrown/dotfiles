#!/usr/bin/env bash

set -e
cd "$(dirname "${0}")/.."

# shellcheck disable=SC1091
. script/functions

# Set up dotdrop dependencies
git submodule update --init --recursive
git submodule update --remote dotdrop

script/setup-dotdrop-venv.sh

# Install oh-my-zsh
if [ ! -d ~/.oh-my-zsh ]; then
  if command -v curl >/dev/null; then
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh) --unattended"
  elif command -v wget >/dev/null; then
    sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -) --unattended"
  else
    abort "Either curl or wget must be installed"
  fi
fi

# Install all dotfiles into the home directory
ensure_command "yq"

# create a new profile (if necessary) and include default
PROFILE=$(hostname)
if [ -z "$(yq e ".profiles.\"${PROFILE}\" // \"\"" config.yaml)" ]; then
  yq eval ".profiles.\"${PROFILE}\".\"include\" += [\"default\"]" -i config.yaml
  if is_mac; then
    yq eval ".profiles.\"${PROFILE}\".\"include\" += [\"mac\"]" -i config.yaml
  elif is_linux; then
    yq eval ".profiles.\"${PROFILE}\".\"include\" += [\"linux\"]" -i config.yaml
  fi
  for extra in "${@}"; do
    yq eval ".profiles.\"${PROFILE}\".\"include\" += [\"${extra}\"]" -i config.yaml
  done
fi

script/extract-onepassword-secrets.sh

./dotdrop.sh install --force --profile="${PROFILE}"

for extra in "${@}"; do
  if [ -f "./script/bootstrap-${extra}" ]; then
    "./script/bootstrap-${extra}"
  fi
done
